<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Harvesters Hub</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      margin: 0;
      padding-top: 70px; /* avoid content hiding behind fixed header */
    }

    header {
      background: #fff;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      height: 65px;
      transition: transform 0.3s ease-in-out;
    }

    header.hidden {
      transform: translateY(-100%);
    }

    /* âœ… Post */
  .post {
  max-width: 400px;
  margin: 20px auto;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: #fff;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

/* âœ… Media */
.post img, 
.post video {
  width: 100%;
  display: block;
}

/* âœ… Post Header */
.post-header {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  border-bottom: 1px solid #eee;
  background: #fafafa;
}

/* Uploader logo */
.uploader-logo {
  max-width: 100px;
  height: 40px;
  border-radius: 50%; 
  object-fit: cover;
  margin-right: 10px;
  border: 1px solid #ddd;
}

/* Uploader info */
.uploader-info {
  display: flex;
  flex-direction: column;
}

.uploader-info h4 {
  margin: 0;
  font-size: 14px;
  font-weight: bold;
  color: #333;
}

.post-time {
  font-size: 12px;
  color: #888;
}
    .actions {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 15px;
      padding: 10px;
    }

    .actions i {
      font-size: 24px;
      cursor: pointer;
    }

    .liked {
      color: red;
    }

    .likes {
      padding: 0 10px 10px;
      font-weight: bold;
    }

    .caption {
      padding: 10px;
      font-size: 14px;
      color: #333;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }

    .message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: black;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      opacity: 0.9;
      display: none;
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      padding: 10px 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 10px;
      margin: 5px;
      border-radius: 5px;
    }

    .navbar img {
      height: 20px;
    }

    .navbar h1 {
      flex-grow: 1;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin: 0;
    }

    @media (max-width: 600px) {
      .navbar {
        justify-content: center;
      }
      .navbar img { order: 1; }
      .navbar h1 {
        order: 2;
        flex: 1 1 100%;
        text-align: center;
        font-size: 16px;
      }
    }

      /* Footer Card */
.footer {
  background: #fff;
  padding: 10px 20px;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  position: sticky;
  bottom: 0;
}
.footer-item {
  flex: 1;
  text-align: center;
  font-size: 18px;
  cursor: pointer;
  color: #333;
}
.footer-item.center {
  font-size: 28px;
  font-weight: bold;
  color: black;
}
.menu-bars {
  display: inline-block;
}
.bar {
  width: 22px;
  height: 3px;
  background-color: #333;
  margin: 4px 0;
  border-radius: 2px;
}

/* Sidebar */
.sidebar {
  position: fixed;
  top: 0;
  right: -270px;
  width: 270px;
  height: 100%;
  background: #fff;
  box-shadow: -2px 0 6px rgba(0,0,0,0.2);
  transition: right 0.3s ease;
  z-index: 20;
  overflow-y: auto;
}
.sidebar.open { right: 0; }

.sidebar-content {
  padding: 20px;
}

.user-info {
  text-align: center;
  margin-bottom: 20px;
}
.user-info img {
  width: 180px;
  height: 80px;
  border-radius: 20%;
  border: 2px solid #ddd;
  object-fit: cover;
}
.user-info h3 {
  margin-top: 10px;
  font-size: 18px;
  color: #333;
}

/* Sidebar buttons */
.sidebar-btn {
  display: block;
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f9f9f9;
  text-align: center;
  font-size: 15px;
  color: #333;
  text-decoration: none;
  transition: background 0.2s;
}
.sidebar-btn:hover {
  background: #eee;
}

/* Logout button */
.logout-btn {
  width: 100%;
  padding: 12px;
  border: 1px solid #f5c2c7;
  border-radius: 8px;
  background: #f8d7da;
  color: #842029;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.logout-btn:hover {
  background: #f5c2c7;
      }

  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <header>
    <div class="navbar">
      <img src="uploads/harvesters.png" alt="Harvesters Logo">
      <h1>Harvesters Hub ðŸ˜Š</h1>
    </div>
  </header>

  <div id="feed"></div>

  <div class="message" id="messageBox"></div>

  <!-- âœ… Footer -->
<div class="footer" id="footer" style="display:none;">
  <div class="footer-item" id="homeBtn">Home</div>
  <div class="footer-item center" id="uploadBtn">+</div>
  <div class="footer-item" id="menuBtn">
    <div class="menu-bars">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
  </div>
</div>

<!-- âœ… Sidebar -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-content">
    <span id="closeSidebar" style="cursor:pointer;font-size:20px;float:right;">&times;</span>
    
    <!-- User Info -->
    <div class="user-info">
      <img id="sidebarUserLogo" src="" alt="User Logo">
      <h3 id="sidebarUserName"></h3>
    </div>
    
    <!-- Buttons will render here -->
    <div id="sidebarButtons"></div>

    <!-- Logout -->
    <div style="margin-top: 30px; text-align:center;">
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </div>
</div>

  <script>
    const API_URL = "https://harvesters-hub-fbgo.onrender.com";

        async function fetchUploads() {
  try {
    const res = await fetch(`${API_URL}/api/uploads`);
    const json = await res.json();

    if (!json.success) throw new Error("Failed to fetch uploads");

    const uploads = json.data.map(u => ({
      _id: u._id,
      fileUrl: u.url,
      fileType: u.type || "image",  // âœ… now from schema
      likes: u.likes || 0,
      comments: u.comments || "",
      liked: isPostLiked(u._id),

      // âœ… uploader info
      uploaderName: u.uploaderName,
      uploaderLogo: u.uploaderLogo,
      uploaderRole: u.uploaderRole,
      createdAt: u.createdAt
    }));

    renderPosts(uploads);
  } catch (err) {
    console.error("Error fetching uploads:", err);
  }
}

// Helper: format time ago
function timeAgo(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);

  let interval = Math.floor(seconds / 31536000);
  if (interval >= 1) return interval + " year" + (interval > 1 ? "s" : "") + " ago";

  interval = Math.floor(seconds / 2592000);
  if (interval >= 1) return interval + " month" + (interval > 1 ? "s" : "") + " ago";

  interval = Math.floor(seconds / 86400);
  if (interval >= 1) return interval + " day" + (interval > 1 ? "s" : "") + " ago";

  interval = Math.floor(seconds / 3600);
  if (interval >= 1) return interval + " hr" + (interval > 1 ? "s" : "") + " ago";

  interval = Math.floor(seconds / 60);
  if (interval >= 1) return interval + " min" + (interval > 1 ? "s" : "") + " ago";

  return "Just now";
}

    function renderPosts(uploads) {
  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  uploads.forEach(upload => {
    const post = document.createElement("div");
    post.className = "post";
    post.id = `post-${upload._id}`;

    // âœ… Uploader header
    const header = document.createElement("div");
    header.className = "post-header";

    const logo = document.createElement("img");
    logo.src = upload.uploaderLogo || "default-logo.png";
    logo.alt = `${upload.uploaderName}'s logo`;
    logo.className = "uploader-logo";

    const info = document.createElement("div");
    info.className = "uploader-info";

    const name = document.createElement("h4");
    name.textContent = upload.uploaderName;

    const time = document.createElement("span");
    time.className = "post-time";
    time.textContent = timeAgo(upload.createdAt);

    info.appendChild(name);
    info.appendChild(time);

    header.appendChild(logo);
    header.appendChild(info);

    // âœ… Media (image or video)
    let mediaEl;
    if (upload.fileType === "video") {
      mediaEl = document.createElement("video");
      mediaEl.src = upload.fileUrl;
      mediaEl.controls = true;
    } else {
      mediaEl = document.createElement("img");
      mediaEl.src = upload.fileUrl;
    }

     mediaEl.addEventListener("click", () => {
          window.location.href = `post.html?id=${upload._id}`;
        });
    

    // âœ… Caption
    const caption = document.createElement("div");
    caption.className = "caption";
    caption.textContent = upload.comments || "";

    // âœ… Actions
    const actions = document.createElement("div");
    actions.className = "actions";

    const likeIcon = document.createElement("i");
    likeIcon.className = upload.liked
      ? "fa-solid fa-heart liked"
      : "fa-regular fa-heart";

    const shareIcon = document.createElement("i");
    shareIcon.className = "fa-solid fa-share";

    const downloadIcon = document.createElement("i");
    downloadIcon.className = "fa-solid fa-download";

    actions.appendChild(likeIcon);
    actions.appendChild(shareIcon);
    actions.appendChild(downloadIcon);

    const likesCount = document.createElement("div");
    likesCount.className = "likes";
    likesCount.textContent = `${upload.likes || 0} likes`;

    // âœ… Event Listeners
    likeIcon.addEventListener("click", () =>
      handleLikeToggle(upload, likeIcon, likesCount)
    );
    mediaEl.addEventListener("dblclick", () =>
      handleLikeToggle(upload, likeIcon, likesCount)
    );

    shareIcon.addEventListener("click", () => {
      const postLink = `${window.location.origin}/post.html?id=${upload._id}`;
      if (navigator.share) {
        navigator.share({
          title: "Check out this post!",
          url: postLink
        }).catch(err => console.log("Share cancelled", err));
      } else {
        navigator.clipboard.writeText(postLink).then(() => {
          showMessage("ðŸ”— Post link copied to clipboard âœ…");
        });
      }
    });

    downloadIcon.addEventListener("click", () => {
      if (confirm("Do you want to download this file?")) {
        const a = document.createElement("a");
        a.href = upload.fileUrl;
        a.download = upload.fileUrl.split("/").pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    });

    // âœ… Build post
    post.appendChild(header);
    post.appendChild(mediaEl);
    post.appendChild(caption);
    post.appendChild(actions);
    post.appendChild(likesCount);

    feed.appendChild(post);
  });
    }

        
    // Handle Likes 
    async function handleLikeToggle(upload, icon, likesCountEl) {
  try {
    if (!upload._id) return;

    const res = await fetch(`${API_URL}/api/uploads/${upload._id}/like`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ deviceId: getDeviceId() })
});

const data = await res.json(); // only once

if (!res.ok) {
  console.error("Failed to like/unlike:", data);
  showMessage(data.error || "Failed to like/unlike âŒ");
  return;
        }

    // Update local upload object
    upload.likes = data.likes;
    upload.liked = data.liked;

    // Update UI
    likesCountEl.textContent = `${upload.likes} likes`;
    icon.className = upload.liked ? "fa-solid fa-heart liked" : "fa-regular fa-heart";

    // Save/remove in localStorage
    if (upload.liked) saveLike(upload._id);
    else removeLike(upload._id);

  } catch (err) {
    console.error("Error toggling like:", err);
    showMessage("Server error âŒ");
  }
    }

    // --- LocalStorage Helpers ---
    function getDeviceId() {
      let deviceId = localStorage.getItem("deviceId");
      if (!deviceId) {
        deviceId = `device-${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem("deviceId", deviceId);
      }
      return deviceId;
    }

    function isPostLiked(postId) {
      const likedPosts = JSON.parse(localStorage.getItem("likedPosts") || "[]");
      return likedPosts.includes(postId);
    }

    function saveLike(postId) {
      const likedPosts = JSON.parse(localStorage.getItem("likedPosts") || "[]");
      if (!likedPosts.includes(postId)) {
        likedPosts.push(postId);
        localStorage.setItem("likedPosts", JSON.stringify(likedPosts));
      }
    }

    function removeLike(postId) {
      let likedPosts = JSON.parse(localStorage.getItem("likedPosts") || "[]");
      likedPosts = likedPosts.filter(id => id !== postId);
      localStorage.setItem("likedPosts", JSON.stringify(likedPosts));
    }

    function showMessage(msg) {
      const box = document.getElementById("messageBox");
      box.textContent = msg;
      box.style.display = "block";
      setTimeout(() => {
        box.style.display = "none";
      }, 2000);
    }

    fetchUploads();

    let lastScrollTop = 0;
    const header = document.querySelector("header");

    window.addEventListener("scroll", () => {
      const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      if (currentScroll > lastScrollTop) {
        header.classList.add("hidden");
      } else {
        header.classList.remove("hidden");
      }
      lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
    }, false);

    // âœ… Show footer only for logged in campus/district/cell users
(function checkUser() {
  const user = JSON.parse(localStorage.getItem("user"));
  if (user && ["campus","district","cell"].includes(user.role)) {
    document.getElementById("footer").style.display = "flex";
  }
})();

// âœ… Footer actions
document.getElementById("homeBtn").addEventListener("click", () => {
  window.scrollTo({ top: 0, behavior: "smooth" });
  fetchUploads(); // refresh feed
});

document.getElementById("uploadBtn").addEventListener("click", () => {
  window.location.href = "upload.html";
});

document.getElementById("menuBtn").addEventListener("click", () => {
  document.getElementById("sidebar").classList.add("open");
});

document.getElementById("closeSidebar").addEventListener("click", () => {
  document.getElementById("sidebar").classList.remove("open");
});
    // âœ… Populate sidebar with user info + role-specific buttons
     // Get user from localStorage
  const user = JSON.parse(localStorage.getItem("user"));

  function loadSidebarUser() {
    if (!user) return;

    // Set name & logo directly from localStorage
    document.getElementById("sidebarUserName").textContent = user.name || "";
    document.getElementById("sidebarUserLogo").src = user.logo || "default-logo.png"; 
  }

  loadSidebarUser();

  // Sidebar buttons
  const sidebarButtons = document.getElementById("sidebarButtons");
  sidebarButtons.innerHTML = "";

  let buttons = [];
  if (user && user.role === "campus") {
    buttons = [
      { label: "Register District", link: "district-registration.html" },
      { label: "View Districts", link: "district-dashboard.html" },
      { label: "Register Cell", link: "cell-registration.html" },
      { label: "View Cells", link: "cell-dashboard.html" }
    ];
  } else if (user && user.role === "district") {
    buttons = [
      { label: "Register Cell", link: "cell-registration.html" },
      { label: "View Cells", link: "cell-dashboard.html" }
    ];
  } else if (user && user.role === "cell") {
    buttons = [
      { label: "Register Members", link: "cellMembership-registration.html" },
      { label: "View Members", link: "members-dashboard.html" }
    ];
  }

  buttons.forEach(btn => {
    const a = document.createElement("a");
    a.href = btn.link;
    a.textContent = btn.label;
    a.className = "sidebar-btn";
    sidebarButtons.appendChild(a);
  });
    
// âœ… Logout handler
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("user"); // clear login
  window.location.href = "homepage.html"; // redirect to general homepage
});

// Run renderSidebar when sidebar opens
document.getElementById("menuBtn").addEventListener("click", () => {
  renderSidebar();
  document.getElementById("sidebar").classList.add("open");
});
  </script>
</body>
</html>
